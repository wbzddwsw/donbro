<div class="demo">
  <div id="player1"></div>
</div>

<script>
  var ap = new APlayer({
    element: document.getElementById('player1'),
    fixed: true,
    autoplay: false,
    mini: true,
    theme: '#f8f4fc',
    loop: 'all',
    order: 'random',
    preload: 'auto',
    volume: 0.2,
    mutex: true,
    listFolded: true,
    listMaxHeight: '500px',
    lrcType: 0,
    music: [
      {
        name: 'Bliss',
        artist: 'milet',
        url: '{{ "music/Bliss.mp3" | relURL }}',
        cover: '{{ "cover.jpg" | relURL }}'
      },
      {
        name: '涉川',
        artist: '不才',
        url: '{{ "music/涉川.mp3" | relURL }}',
        cover: '{{ "cover.jpg" | relURL }}'
      }
    ]
  });

  let restoring = true;

  window.addEventListener('load', function () {
    const savedIndex = localStorage.getItem('aplayer-currentIndex');
    const savedTime = localStorage.getItem('aplayer-currentTime');
    const savedPaused = localStorage.getItem('aplayer-paused');

    ap.once('canplay', function () {
      if (savedIndex !== null) {
        ap.list.switch(parseInt(savedIndex));
      }
      if (savedTime !== null) {
        const time = parseFloat(savedTime);
        if (!isNaN(time) && isFinite(time) && time > 0) {
          ap.seek(time);
        }
      }
      if (savedPaused === 'false') {
        ap.play().catch(() => {
          // 浏览器限制自动播放，用户无交互时可能失败
        });
      }
      restoring = false;
    });
  });

  ap.on('timeupdate', function (currentTime) {
    if (!restoring) {
      localStorage.setItem('aplayer-currentTime', currentTime);
    }
  });

  ap.on('switch', function (index) {
    if (!restoring) {
      localStorage.setItem('aplayer-currentIndex', index);
      localStorage.setItem('aplayer-currentTime', 0);
    }
  });

  ap.on('pause', function () {
    if (!restoring) {
      localStorage.setItem('aplayer-paused', 'true');
    }
  });

  ap.on('play', function () {
    if (!restoring) {
      localStorage.setItem('aplayer-paused', 'false');
    }
  });
</script>